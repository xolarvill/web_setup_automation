# Project settings
APP_NAME = WSA
MAIN_SCRIPT = app.py
VERSION ?= 1.0.0
DIST_DIR = dist
RESOURCES_DIR = resources
VENV_DIR = .venv
UV = uv
PYTHON = $(VENV_DIR)/bin/python
PYINSTALLER = $(VENV_DIR)/bin/pyinstaller

# Icon paths
WIN_ICON = $(RESOURCES_DIR)/icon.ico
MAC_ICON = $(RESOURCES_DIR)/icon.icns

# Platform detection (for paths)
OS := $(shell uname -s)
ifeq ($(OS),Windows_NT)
    PYTHON = $(VENV_DIR)/Scripts/python.exe
    PYINSTALLER = $(VENV_DIR)/Scripts/pyinstaller.exe
endif

# Common PyInstaller options
PYINSTALLER_OPTS = \
    --name $(APP_NAME)_v$(VERSION) \
    --distpath $(DIST_DIR) \
    --workpath build \
    --noconfirm \
    --onefile

# Default target
.PHONY: all
all: build-all

# Setup virtual environment and install dependencies
.PHONY: setup
setup:
	@echo "Setting up virtual environment and dependencies..."
	$(UV) venv
	$(UV) sync
	$(UV) pip install pyinstaller
ifeq ($(OS),Windows_NT)
	$(UV) pip install dmgbuild
endif

# Build both Windows .exe and macOS .app
.PHONY: build-all
build-all: setup clean build-win build-mac
	@echo "Build completed: Windows .exe and macOS .app in $(DIST_DIR)/"

# Build Windows .exe
.PHONY: build-win
build-win: setup
	@echo "Building $(APP_NAME) for Windows..."
	$(PYINSTALLER) $(PYINSTALLER_OPTS) \
		--icon $(WIN_ICON) \
		$(MAIN_SCRIPT)
	@echo "Windows build completed: $(DIST_DIR)/$(APP_NAME)_v$(VERSION).exe"

# Build macOS .app
.PHONY: build-mac
build-mac: setup
	@echo "Building $(APP_NAME) for macOS..."
	$(PYINSTALLER) $(PYINSTALLER_OPTS) \
		--icon $(MAC_ICON) \
		--windowed \
		$(MAIN_SCRIPT)
	@echo "macOS build completed: $(DIST_DIR)/$(APP_NAME)_v$(VERSION).app"

# Clean build artifacts
.PHONY: clean
clean:
	@echo "Cleaning up..."
	rm -rf $(DIST_DIR) build *.spec
	@echo "Cleanup completed."

# Help message
.PHONY: help
help:
	@echo "Makefile for $(APP_NAME) packaging"
	@echo "Usage:"
	@echo "  make [target] [VERSION=x.y.z]"
	@echo "Targets:"
	@echo "  all        : Build both Windows .exe and macOS .app (default)"
	@echo "  build-all  : Same as 'all'"
	@echo "  build-win  : Build Windows .exe only"
	@echo "  build-mac  : Build macOS .app only"
	@echo "  clean      : Remove build artifacts"
	@echo "  setup      : Set up virtual environment and install dependencies"
	@echo "  help       : Show this help message"
	@echo "Example:"
	@echo "  make build-all VERSION=1.1.0"